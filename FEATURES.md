# ChzzkRPG 플러그인 기능 문서

> **버전:** 1.0-SNAPSHOT
> **플랫폼:** Paper API 1.21
> **개발자:** Antigravity

---

## 목차

1. [스탯 시스템](#1-스탯-시스템)
2. [직업 시스템](#2-직업-시스템)
3. [전투 시스템](#3-전투-시스템)
4. [길드 시스템](#4-길드-시스템)
5. [토지 관리 시스템](#5-토지-관리-시스템)
6. [건설 계약 시스템](#6-건설-계약-시스템)
7. [아이템 강화 시스템](#7-아이템-강화-시스템)
8. [등급 시스템](#8-등급-시스템)
9. [큐브 시스템](#9-큐브-시스템)
10. [음식 버프 시스템](#10-음식-버프-시스템)
11. [GUI 시스템](#11-gui-시스템)
12. [명령어 목록](#12-명령어-목록)
13. [외부 플러그인 연동](#13-외부-플러그인-연동)
14. [권한 목록](#14-권한-목록)
15. [데이터베이스](#데이터베이스)
16. [기술 스택](#기술-스택)
17. [데이터 저장 방식](#데이터-저장-방식)
18. [성능 최적화](#성능-최적화)
19. [플레이어 세션 관리](#플레이어-세션-관리)

---

## 1. 스탯 시스템

플레이어의 능력치를 관리하는 핵심 시스템입니다.

### 스탯 종류

| 스탯 | 설명 | 기본값 |
|------|------|--------|
| ATK | 공격력 | 0.0 |
| DEF | 방어력 | 0.0 |
| HP | 최대 체력 | 0.0 |
| CRIT | 치명타 확률 (%) | 0.0 |
| CRIT_DMG | 치명타 데미지 배율 | 1.5 (150%) |
| PEN | 관통력 (%) | 0.0 |

### 스탯 포인트

- 플레이어는 스탯 포인트를 받아 원하는 스탯에 투자할 수 있습니다
- 관리자가 `/rpgadmin setpoints` 명령어로 포인트 지급 가능

### 스탯 재계산 시스템

총 스탯은 다음 순서로 계산됩니다:

```
1. 기본 스탯 (baseStats) 복사
2. 전투 직업 보너스 적용 (combatJob.applyStats)
3. 활성 버프 스탯 합산
4. (TODO) 장비 스탯 적용
```

**재계산 트리거:**
- 버프 추가 시
- 버프 만료 시 (1초마다 정리)

---

## 2. 직업 시스템

### 전투 직업

플레이어가 선택할 수 있는 전투 스타일을 결정합니다.

| 직업 | 한글명 | ATK 배율 | DEF 배율 | 특수 효과 |
|------|--------|----------|----------|-----------|
| NONE | 무직 | 1.0x | 1.1x | - |
| WARRIOR | 전사 | 1.2x | 1.1x | - |
| ARCHER | 궁수 | 1.1x | 0.9x | - |
| MAGE | 마법사 | 1.3x | 0.8x | - |
| ROGUE | 도적 | 1.1x | 0.8x | +10% CRIT, +50% CRIT_DMG |

### 생활 직업

경제 활동과 관련된 직업입니다.

| 직업 | 한글명 | 기능 |
|------|--------|------|
| NONE | 무직 | - |
| BLACKSMITH | 대장장이 | 아이템 수리, 강화 성공률 보너스 |
| CHEF | 요리사 | 음식 섭취 시 버프 제공 |
| BUILDER | 건축가 | 건설 계약 수행, 건축 모드 사용 |

### 생활 직업 레벨링

각 생활 직업은 개별 레벨과 경험치를 가집니다:
- `blacksmith_level` / `blacksmith_exp`
- `chef_level` / `chef_exp`
- `builder_level` / `builder_exp`

---

## 3. 전투 시스템

### 무기 시스템

**무기 타입:**

| 타입 | 설명 |
|------|------|
| SWORD | 근접 무기 |
| RANGED | 원거리 무기 (활) |
| NONE | 미분류 |

**무기 속성:**
- `baseAtk`: 기본 공격력
- `attackSpeed`: 공격 속도 (APS - Attacks Per Second)
- `enhanceLevel`: 강화 단계 (0~10)
- `ownerUuid`: 귀속 플레이어 UUID
- `bonusStats`: 추가 스탯 (ATK, CRIT, PEN 등)

**강화 보너스:** 강화 단계당 +2.0 공격력

**무기 Lore 자동 표시:**
- 무기 타입
- 총 공격력 (기본 + 강화 보너스)
- 공격 속도 (APS)
- 귀속 플레이어 이름

### 데미지 계산 공식

**플레이어 → 몹/플레이어:**
```
1. totalAtk = 플레이어 ATK + 무기 ATK + 강화 보너스
2. effectiveDef = 방어력 × (1 - 관통력/100)
3. baseDamage = max(1.0, totalAtk - max(0, effectiveDef))
4. finalDamage = baseDamage × critDmg (크리티컬 발생 시)
```

**몹 → 플레이어 (MythicMobs 호환):**
```
1. originalDamage = 몹의 공격력 (MythicMobs 포함)
2. damageReduction = 100 / (100 + DEF)
3. finalDamage = max(1.0, originalDamage × damageReduction)
```

**DEF 효율표:**

| DEF | 데미지 감소율 |
|-----|---------------|
| 0 | 0% |
| 50 | 33% |
| 100 | 50% |
| 200 | 67% |
| 300 | 75% |

### MythicMobs 연동

- MythicMobs 몹이 플레이어를 공격하면 자동으로 DEF 적용
- MythicMobs의 커스텀 데미지도 감소 처리됨
- 액션바로 받은 데미지와 DEF 감소량 표시

### 공격 쿨다운

- 무기별 공격 속도(APS)에 따라 쿨다운 적용
- 쿨다운 계산: `cooldownTicks = 20 / APS`
- 쿨다운 중 공격 시 데미지가 적용되지 않음

### 크리티컬 시스템

- CRIT 스탯에 따른 확률로 크리티컬 발생
- 크리티컬 발생 시 CRIT_DMG 배율 적용

### 원거리 공격

**즉발 사격 시스템:**
- 바닐라 활 차징 무시
- 우클릭 즉시 화살 발사
- 화살 속도 2배 가속

**투사체 데이터 스냅샷:**
- 발사 시 무기 데이터를 화살 PDC에 저장
- 저장 데이터: baseAtk, enhanceLevel, weaponType
- 적중 시 저장된 데이터로 데미지 계산

**원거리 무기 조건:**
- WeaponType이 RANGED인 무기만 해당
- 귀속 무기는 소유자만 발사 가능

### 데미지 표시

**액션바 표시:**
- 일반 공격: `§7Damage: §f{데미지}`
- 크리티컬: `§cCRITICAL! §f{데미지}`
- 소수점 첫째 자리까지 표시

### 귀속(Soulbound) 시스템

귀속된 무기는 소유자만 사용할 수 있으며, 다양한 악용 방지 기능이 구현되어 있습니다.

**기본 제한:**

| 행동 | 제한 내용 |
|------|-----------|
| 픽업 | 다른 플레이어/엔티티 픽업 불가 |
| 드롭 | 의도적 드롭 불가 |
| 공격 | 귀속되지 않은 플레이어는 사용 불가 |

**인벤토리 보호:**

| 보호 대상 | 설명 |
|-----------|------|
| 상자 저장 | 상자/배럴 등에 저장 불가 |
| 셜커박스 | 셜커박스에 저장 불가 |
| 호퍼 이동 | 호퍼로 이동 불가 |
| 디스펜서 | 디스펜서로 배출 불가 |
| 드래그 | 외부 인벤토리로 드래그 불가 |
| 핫바 스왑 | 숫자키로 외부 인벤토리에 스왑 불가 |

**진열 방지:**

- 아이템 프레임 진열 불가
- 갑옷 거치대 장착 불가
- 오프핸드 스왑 제한

**바닐라 시스템 차단:**

| 시스템 | 차단 내용 |
|--------|-----------|
| 모루 | 귀속 무기 수리/이름 변경 불가 |
| 숫돌 | 귀속 무기 인챈트 제거 불가 |
| 대장장이 작업대 | 귀속 무기 업그레이드 불가 |
| 인챈트 테이블 | 귀속 무기 인챈트 불가 |
| 조합대 | 귀속 무기 조합 재료 사용 불가 |

**사망 시 처리:**

- 사망해도 귀속 아이템은 드롭되지 않음
- 부활 시 자동으로 인벤토리에 복원
- 인벤토리가 가득 차면 대기열에 보관
- 재접속 시 대기 중인 아이템 자동 지급
- `soulbound_returns.yml` 파일에 영구 저장

---

## 4. 길드 시스템

### 길드 구조

- **길드 이름**: 고유한 이름 (최대 32자)
- **길드 레벨**: 길드의 성장도
- **길드 경험치**: 레벨업에 필요한 경험치

### 멤버 역할

| 역할 | 한글명 | 권한 |
|------|--------|------|
| LEADER | 길드장 | 모든 권한 |
| OFFICER | 장교 | 멤버 관리 |
| MEMBER | 멤버 | 기본 권한 |

### 길드 기능

- 길드 생성
- 멤버 초대 및 가입
- 길드 정보 조회
- 길드 토지 구매

---

## 5. 토지 관리 시스템

### 토지 구매

- **단위**: 청크 (16x16 블록)
- **가격**: 1,000원 (config에서 설정 가능)
- **종류**: 개인 토지, 길드 토지

### 소유권 유형

| 유형 | 설명 |
|------|------|
| PERSONAL | 개인 소유 토지 |
| GUILD | 길드 소유 토지 |

### 토지 보호 시스템

클레임된 토지는 다음 행동이 제한됩니다:

| 보호 항목 | 설명 |
|-----------|------|
| 블록 설치 | 소유자/길드원/계약자만 가능 |
| 블록 파괴 | 소유자/길드원/계약자만 가능 |
| 상호작용 | 상자, 문 등 interactable 블록 보호 |
| 버킷 사용 | 물/용암 설치 및 수거 보호 |
| 폭발 피해 | TNT, 크리퍼 등 폭발로부터 블록 보호 |

**권한 우회 조건:**
- OP 플레이어
- 토지 소유자 (개인 클레임)
- 길드 멤버 (길드 클레임)
- 활성 계약 건축가

### Multiverse 호환

- `config.yml`에서 특정 월드만 토지 구매 허용 가능
- 비어있으면 모든 월드에서 구매 가능

---

## 6. 건설 계약 시스템

### 계약 흐름

```
1. 의뢰자: 소유 토지에 계약 생성 (보상금 + 예산 에스크로)
2. 건축가: 계약 수락
3. 건축가: 건축 모드로 블록 배치 (예산에서 차감)
4. 의뢰자: 계약 완료 승인
5. 건축가에게 보상금 지급, 남은 예산 반환
```

### 계약 상태

| 상태 | 설명 |
|------|------|
| OPEN | 대기 중 (건축가 수락 대기) |
| ACTIVE | 진행 중 |
| COMPLETED | 완료됨 |
| CANCELLED | 취소됨 |

### 건축 모드

- `/builder` 명령어로 토글
- 활성화 시 크리에이티브 모드로 전환
- 블록 배치 시 계약 예산에서 비용 차감

**블록별 건축 비용:**

| 블록 | 비용 |
|------|------|
| 다이아몬드 블록 | $500 |
| 금 블록 | $200 |
| 철 블록 | $100 |
| 기타 블록 | $10 |

**건축 모드 특징:**
- 블록 파괴 시 드롭 방지 (아이템/경험치)
- 로그아웃 시 자동 해제
- 이전 게임모드 자동 복원
- 계약 영역 내 우선 예산 차감, 없으면 개인 지갑 사용

---

## 7. 아이템 강화 시스템

### 강화 단계

0단계부터 10단계까지 강화 가능

### 강화 성공률

| 단계 | 성공률 |
|------|--------|
| 0→1 | 100% |
| 1→2 | 90% |
| 2→3 | 80% |
| 3→4 | 70% |
| 4→5 | 60% |
| 5→6 | 50% |
| 6→7 | 40% |
| 7→8 | 30% |
| 8→9 | 20% |
| 9→10 | 10% |

### 강화 실패 결과 (5단계 이상)

| 확률 | 결과 |
|------|------|
| 10% | 아이템 파괴 |
| 30% | 강화 등급 하락 |
| 60% | 실패만 (유지) |

### 대장장이 보너스

- 기본 보너스: +5%
- 레벨당 추가: +0.5%

### 강화 주문서

- 관리자가 `/rpgadmin givescroll` 명령어로 지급
- 강화 시 주문서 소모

### 강화 사운드 효과

| 결과 | 사운드 |
|------|--------|
| 성공 | BLOCK_ANVIL_USE (높은 피치) |
| 실패 | BLOCK_ANVIL_LAND (낮은 피치) |
| 등급 하락 | ENTITY_ITEM_BREAK |
| 파괴 | ENTITY_GENERIC_EXPLODE |

### 강화 제한

- 귀속 무기는 소유자만 강화 가능
- 최대 강화 단계(+10) 도달 시 강화 불가

---

## 8. 등급 시스템

무기의 등급을 올려 추가 스탯 슬롯을 해방하는 성장 시스템입니다.

### 등급 종류

| 등급 | 한글명 | 색상 | 추가 스탯 슬롯 | 스탯 배율 |
|------|--------|------|----------------|-----------|
| COMMON | 일반 | §f (흰색) | 0 | 1.0x |
| UNCOMMON | 고급 | §a (연두) | 1 | 1.2x |
| RARE | 희귀 | §9 (파랑) | 2 | 1.5x |
| EPIC | 영웅 | §5 (보라) | 3 | 2.0x |
| LEGENDARY | 전설 | §6 (금색) | 4 | 2.5x |
| MYTHIC | 신화 | §c (빨강) | 5 | 3.0x |

### 추가 스탯 (Bonus Stats)

등급 상승 시 랜덤하게 해방되는 추가 능력치입니다.

**적용 가능한 스탯:**

| 스탯 | 기본 범위 | 가중치 |
|------|-----------|--------|
| ATK (공격력) | 1.0 ~ 5.0 | 30% |
| DEF (방어력) | 1.0 ~ 5.0 | 30% |
| CRIT (치명타 확률) | 0.5% ~ 2.0% | 15% |
| CRIT_DMG (치명타 데미지) | 2% ~ 8% | 12% |
| PEN (관통력) | 0.5% ~ 2.0% | 13% |

**스탯 범위 계산:**
```
실제 범위 = 기본 범위 × 등급 스탯 배율
```

예시: EPIC 등급에서 ATK 스탯 → 1.0~5.0 × 2.0 = 2.0~10.0

### 등급 승급 조건

- **직업 제한**: 대장장이(BLACKSMITH) 직업만 승급 가능
- **재료**: 등급석 필요 (등급별 소모량 다름)
- **비용**: 골드 필요 (등급별 비용 다름)
- **귀속**: 자신에게 귀속된 무기만 승급 가능

### 대장장이 보너스

| 항목 | 수치 |
|------|------|
| 기본 보너스 | +5% |
| 레벨당 추가 | +0.5% |

**계산식:**
```
최종 성공률 = 기본 성공률 + 5% + (대장장이 레벨 × 0.5%)
```

### 승급 결과

| 결과 | 설명 | 사운드 |
|------|------|--------|
| 성공 | 등급 상승, 새 추가 스탯 해방 | UI_TOAST_CHALLENGE_COMPLETE |
| 실패 | 등급 유지 (하락 없음) | BLOCK_ANVIL_LAND |

### 등급별 기본 공격력

등급 상승 시 무기의 기본 공격력도 증가합니다.

```
기본 공격력 = 무기 타입 기본값 × 등급 스탯 배율
```

| 무기 타입 | 기본값 |
|-----------|--------|
| SWORD | 10.0 |
| AXE | 12.0 |
| RANGED | 8.0 |
| STAFF | 9.0 |
| 기타 | 5.0 |

---

## 9. 큐브 시스템

메이플스토리의 큐브와 유사한 스탯 재설정 시스템입니다.

### 큐브 종류

| 큐브 | 한글명 | 색상 | 복원 가능 | 기본 비용 |
|------|--------|------|-----------|-----------|
| BASIC | 일반 큐브 | §f (흰색) | X | 500원 |
| ADVANCED | 고급 큐브 | §6 (금색) | O | 2,000원 |

### 큐브 사용 조건

- 자신에게 귀속된 무기만 사용 가능
- 추가 스탯이 1개 이상 있어야 사용 가능
- 골드 비용 필요

### 큐브 효과

**일반 큐브 (BASIC):**
- 모든 추가 스탯을 새로운 랜덤 값으로 재설정
- 복원 불가능 (확정)

**고급 큐브 (ADVANCED):**
- 모든 추가 스탯을 새로운 랜덤 값으로 재설정
- 이전 스탯으로 복원 가능 (1회)
- 새 스탯 확정 또는 복원 선택 가능

### 고급 큐브 복원 시스템

고급 큐브 사용 시 이전 스탯을 임시 저장합니다.

**사용 가능한 옵션:**
1. **확정**: 새로운 스탯을 유지 (이전 스탯 삭제)
2. **복원**: 이전 스탯으로 되돌리기 (새 스탯 삭제)

**주의사항:**
- 복원은 1회만 가능
- 로그아웃 시 저장된 이전 스탯 데이터 삭제
- 다른 무기에 큐브 사용 시 이전 데이터 삭제

### 사운드 효과

| 행동 | 사운드 |
|------|--------|
| 큐브 사용 | BLOCK_ENCHANTMENT_TABLE_USE |
| 스탯 복원 | BLOCK_BEACON_POWER_SELECT |

---

## 10. 음식 버프 시스템

### 버프 형식

PDC(PersistentDataContainer) 기반 음식 데이터:

| PDC 키 | 설명 | 예시 |
|--------|------|------|
| `rpg_food` | RPG 음식 마커 | "true" |
| `food_stat` | 버프 스탯 | "ATK:10" |
| `food_duration` | 지속 시간 (초) | 60 |

### 지원 버프 스탯

```
ATK:10    → 공격력 +10
DEF:5     → 방어력 +5
HP:20     → 체력 +20
CRIT:5    → 치명타 확률 +5%
CRIT_DMG:0.5 → 치명타 데미지 +50%
PEN:10    → 관통력 +10%
```

### 버프 특징

- PDC 마킹된 음식에만 적용
- 음식 섭취 시 임시 스탯 증가
- 지속시간 후 자동 해제 (1초마다 정리)
- 버프 적용 시 채팅으로 알림

---

## 11. GUI 시스템

### 메인 메뉴 (`/rpg`)

RPG 시스템의 메인 허브 GUI

### 스탯 GUI (`/stats`)

- 현재 스탯 표시
- 스탯 포인트 할당

### 강화 GUI (`/enhance`)

- 아이템 강화 인터페이스
- 성공률 표시
- 강화 진행

---

## 12. 명령어 목록

### 일반 명령어

| 명령어 | 설명 | 권한 |
|--------|------|------|
| `/rpg` | 메인 메뉴 GUI 열기 | rpg.use |
| `/stats` | 스탯 GUI 표시 | rpg.use |
| `/job info` | 현재 직업 정보 | rpg.use |
| `/job join <직업>` | 직업 변경 | rpg.use |
| `/enhance` | 강화 GUI 열기 | rpg.use |
| `/rtp` | 랜덤 텔레포트 | rpg.rtp |

### 랜덤 텔레포트 (RTP) 세부

- **범위**: 현재 위치에서 200~1000 블록 (설정 가능)
- **쿨다운**: 60초 (설정 가능)
- **최대 시도 횟수**: 10회 (설정 가능)

**안전 위치 검사:**
- 월드 경계 내부인지 확인
- 지면: 고체 블록, 액체 아님
- 발/머리: 공기 블록

**월드 제한:**
- Multiverse 연동 시 특정 월드만 허용 가능

### 생활 직업 명령어

| 명령어 | 설명 | 조건 |
|--------|------|------|
| `/builder` | 건축 모드 토글 | BUILDER 직업 |
| `/repair` | 아이템 수리 | BLACKSMITH 직업 |

### 수리 시스템 (`/repair`)

**수리 조건:**
- 생활 직업이 BLACKSMITH인 경우만 사용 가능
- 손에 들고 있는 아이템 대상
- Damageable 아이템만 수리 가능

**수리 동작:**
- 아이템의 내구도를 최대로 복원
- 귀속 무기는 소유자만 수리 가능
- 이미 최대 내구도면 알림 표시

### 토지 명령어

| 명령어 | 설명 |
|--------|------|
| `/land info` | 현재 청크 소유권 정보 |
| `/land claim` | 개인 토지 구매 |
| `/land guildclaim <id>` | 길드 토지 구매 |
| `/land unclaim` | 토지 반환 |

### 길드 명령어

| 명령어 | 설명 |
|--------|------|
| `/guild info` | 길드 정보 표시 |
| `/guild create <이름>` | 길드 생성 |
| `/guild invite <플레이어>` | 플레이어 초대 |
| `/guild join` | 초대된 길드 가입 |

### 계약 명령어

| 명령어 | 설명 |
|--------|------|
| `/contract list` | 열린 계약 목록 |
| `/contract create <보상> <예산>` | 계약 생성 |
| `/contract accept <id>` | 계약 수락 |
| `/contract complete <id>` | 계약 완료 |

### 관리자 명령어

| 명령어 | 설명 | 권한 |
|--------|------|------|
| `/rpgadmin reload` | 설정 리로드 | rpg.admin |
| `/rpgadmin setpoints <플레이어> <양>` | 스탯 포인트 설정 | rpg.admin |
| `/rpgadmin giveweapon <플레이어> <공격력>` | 무기 지급 | rpg.admin |
| `/rpgadmin givescroll <플레이어> <타입>` | 강화 주문서 지급 | rpg.admin |

### 아이템 생성 시스템

**무기 생성 (`/rpgadmin giveweapon`):**
- 다이아몬드 검 기반 생성
- 지정된 공격력으로 WeaponData 자동 설정
- SWORD 타입, 1.0 APS 기본값
- 대상 플레이어에게 귀속

**강화 주문서 생성 (`/rpgadmin givescroll`):**
- 종이(PAPER) 기반 생성
- PDC에 ITEM_TYPE: "SCROLL", SCROLL_TYPE 저장
- 강화 UI에서 사용 가능

---

## 13. 외부 플러그인 연동

### 필수 플러그인

| 플러그인 | 용도 |
|----------|------|
| **Vault** | 경제 시스템 (돈 관리) |

### 선택 플러그인

| 플러그인 | 용도 |
|----------|------|
| **WorldGuard** | 지역별 명령어 제한 (`chzzk-rpg-commands` 플래그) |
| **Multiverse-Core** | 월드별 토지/RTP 설정 |
| **PlaceholderAPI** | 플레이스홀더 지원 |
| **LuckPerms** | 권한 관리 |

### WorldGuard 연동

- 커스텀 플래그: `chzzk-rpg-commands`
- 지역별로 RPG 명령어 실행 제한 가능

### Multiverse 연동

```yaml
# config.yml
compatibility:
  multiverse:
    land-claim-worlds: []  # 비어있으면 모든 월드 허용
    rtp-worlds: []
```

---

## 14. 권한 목록

| 권한 | 기본값 | 설명 |
|------|--------|------|
| `rpg.use` | true | 기본 RPG 명령어 사용 |
| `rpg.admin` | op | 관리자 명령어 (/rpgadmin) |
| `rpg.land.guildclaim` | op | 길드 토지 구매 |
| `rpg.builder` | op | 건축가 권한 |
| `rpg.rtp` | true | 랜덤 텔레포트 |

---

## 데이터베이스

### 지원 타입

- **SQLite** (기본): 단일 서버용
- **MySQL**: 다중 서버/대규모 서버용

### 테이블 구조

| 테이블 | 용도 |
|--------|------|
| `players` | 플레이어 기본 정보, 직업 |
| `player_stats` | 플레이어 스탯 |
| `life_jobs` | 생활 직업 레벨/경험치 |
| `claims` | 토지 소유권 |
| `contracts` | 건설 계약 |
| `guilds` | 길드 정보 |
| `guild_members` | 길드 멤버 |

---

## 설정 파일 (config.yml)

```yaml
database:
  type: sqlite  # sqlite 또는 mysql
  file: "database.db"
  pool-size: 10
  connection-timeout: 30000

compatibility:
  multiverse:
    land-claim-worlds: []
    rtp-worlds: []
  worldguard:
    restricted-commands:
      - rpg
      - stats
      - enhance
      - land

rtp:
  radius-min: 200
  radius-max: 1000
  max-attempts: 10
  cooldown-seconds: 60
```

---

## 테스트 커버리지

구현된 단위 테스트:

- **PlayerStatsTest**: 스탯 시스템 테스트
- **DamageCalculationTest**: 데미지 계산 테스트 (12가지 시나리오)
- **GuildTest**: 길드 시스템 테스트
- **LandTest**: 토지 시스템 테스트
- **GradeSystemTest**: 등급 시스템 테스트
- **CubeSystemTest**: 큐브 시스템 테스트

---

## 기술 스택

| 항목 | 기술 | 버전 |
|------|------|------|
| 플랫폼 | Paper API | 1.21 |
| 언어 | Java | 21 |
| 데이터베이스 | SQLite / MySQL | - |
| 연결 풀 | HikariCP | 5.1.0 |
| 경제 | Vault API | 1.7 |
| 테스트 | JUnit 5 | 5.10.1 |
| 모킹 | Mockito | 5.8.0 |
| 빌드 | Maven | - |
| 유틸리티 | Lombok | - |
| 직렬화 | Gson | - |

---

## 데이터 저장 방식

### PDC (PersistentDataContainer)

아이템 데이터는 PDC에 저장되어 위조 방지 및 영속성을 보장합니다.

**무기 PDC 키:**

| 키 | 타입 | 설명 |
|----|------|------|
| `base_atk` | DOUBLE | 기본 공격력 |
| `attack_speed` | DOUBLE | 공격 속도 (APS) |
| `enhance_level` | INTEGER | 강화 단계 |
| `weapon_type` | STRING | 무기 타입 |
| `owner_uuid` | STRING | 귀속 플레이어 UUID |
| `weapon_grade` | STRING | 무기 등급 (COMMON~MYTHIC) |
| `bonus_stats` | STRING | 추가 스탯 목록 (JSON 형식) |

**등급석/큐브 PDC 키:**

| 키 | 타입 | 설명 |
|----|------|------|
| `grade_stone` | STRING | 등급석 마커 |
| `cube_type` | STRING | 큐브 종류 (BASIC, ADVANCED) |

**강화 주문서 PDC 키:**

| 키 | 타입 | 설명 |
|----|------|------|
| `item_type` | STRING | "SCROLL" |
| `scroll_type` | STRING | 주문서 종류 |

**음식 PDC 키:**

| 키 | 타입 | 설명 |
|----|------|------|
| `rpg_food` | STRING | RPG 음식 마커 |
| `food_stat` | STRING | 버프 스탯 (예: "ATK:10") |
| `food_duration` | INTEGER | 지속 시간 (초) |

---

## 성능 최적화

- **비동기 처리**: 모든 데이터베이스 작업은 비동기로 처리
- **캐싱**: 길드, 토지, 계약 데이터 메모리 캐시
- **연결 풀**: HikariCP로 효율적인 DB 연결 관리
- **동시성**: ConcurrentHashMap으로 쿨다운/세션 관리
- **스케줄러**: 1초마다 버프 만료 정리

---

## 플레이어 세션 관리

### 접속 시 (PlayerJoinEvent)

- 데이터베이스에서 플레이어 프로필 비동기 로드
- 캐시에 프로필 저장
- 대기 중인 귀속 아이템 지급

### 퇴장 시 (PlayerQuitEvent)

- 프로필 데이터베이스에 저장
- 건축 모드 활성화 시 자동 해제
- 귀속 아이템 대기열 파일 저장

### 서버 종료 시 (onDisable)

- 모든 플레이어 프로필 동기 저장
- 귀속 아이템 대기열 즉시 저장 (flushPendingReturns)
- 데이터베이스 연결 종료

---

*이 문서는 ChzzkRPG v1.0-SNAPSHOT 기준으로 작성되었습니다.*
